{% extends 'main.html' %} 
{% load static %} 

{% block meta_title %}{{ article.titre }}{% endblock %} 

{% block content %}
<!-- Page Title -->
<div class="page-title dark-background" data-aos="fade" 
     style="background-image: url('{% static 'assets/img/blog-page-title-bg.jpg' %}')">
  <div class="container">
    <h1>{{ article.titre }}</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{% url 'home' %}">Accueil</a></li>
        <li><a href="{% url 'blog' %}">Blog</a></li>
        <li class="current">{{ article.titre }}</li>
      </ol>
    </nav>
  </div>
</div>
<!-- End Page Title -->

<div class="container">
  <div class="row">
    <div class="col-lg-8">
      <!-- Blog Details Section -->
      <section id="blog-details" class="blog-details section">
        <div class="container">
          <article class="article">
            {% if article.featured_image %}
            <div class="post-img">
              <img src="{{ article.featured_image.url }}" alt="{{ article.featured_image_alt }}" class="img-fluid" />
            </div>
            {% endif %}

            <h2 class="title">{{ article.titre }}</h2>

            <div class="meta-top">
              <ul>
                <li class="d-flex align-items-center">
                  <i class="bi bi-person"></i>
                  <a href="#">{{ article.author.get_full_name }}</a>
                </li>
                <li class="d-flex align-items-center">
                  <i class="bi bi-clock"></i>
                  <time datetime="{{ article.published_at|date:'Y-m-d' }}">
                    {{ article.published_at|date:"d M Y" }}
                  </time>
                </li>
                <li class="d-flex align-items-center">
                  <i class="bi bi-chat-dots"></i>
                  <a href="#blog-comments">{{ comments_count }} Commentaires</a>
                </li>
              </ul>
            </div>

            <div class="content">
              {{ article.content|safe }}
            </div>

            <div class="meta-bottom">
              <i class="bi bi-folder"></i>
              <ul class="cats">
                <li>
                  <a href="{% url 'blog' %}?category={{ article.categorie.slug }}">
                    {{ article.categorie.nom }}
                  </a>
                </li>
              </ul>

              <i class="bi bi-tags"></i>
              <ul class="tags">
                {% for tag in article.tags.all %}
                <li>
                  <a href="{% url 'blog' %}?tag={{ tag.slug }}">{{ tag.name }}</a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </article>
        </div>
      </section>

      <!-- Blog Author Section -->
      <section id="blog-author" class="blog-author section">
        <div class="container">
          <div class="author-container d-flex align-items-center">
            {% if article.author.profile.avatar %}
            <img src="{{ article.author.profile.avatar.url }}" 
                 class="rounded-circle flex-shrink-0" alt="{{ article.author.get_full_name }}" />
            {% else %}
            <img src="{% static 'assets/img/default-avatar.jpg' %}" 
                 class="rounded-circle flex-shrink-0" alt="{{ article.author.get_full_name }}" />
            {% endif %}
            <div>
              <h4>{{ article.author.get_full_name }}</h4>
              <div class="social-links">
                {% if article.author.profile.twitter %}
                <a href="{{ article.author.profile.twitter }}"><i class="bi bi-twitter-x"></i></a>
                {% endif %}
                {% if article.author.profile.facebook %}
                <a href="{{ article.author.profile.facebook }}"><i class="bi bi-facebook"></i></a>
                {% endif %}
                {% if article.author.profile.instagram %}
                <a href="{{ article.author.profile.instagram }}"><i class="bi bi-instagram"></i></a>
                {% endif %}
              </div>
              <p>{{ article.author.profile.bio }}</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Blog Comments Section -->
      <section id="blog-comments" class="blog-comments section">
        <div class="container">
          <h4 class="comments-count">{{ comments_count }} Commentaires</h4>

          {% for comment in comments %}
          <div id="comment-{{ comment.id }}" class="comment">
            <div class="d-flex">
              <div class="comment-img">
                {% if comment.author and comment.author.profile.avatar %}
                <img src="{{ comment.author.profile.avatar.url }}" alt="{{ comment.name }}" />
                {% else %}
                <img src="{% static 'assets/img/default-avatar.jpg' %}" alt="{{ comment.name }}" />
                {% endif %}
              </div>
              <div>
                <h5>
                  <a href="">{{ comment.name }}</a>
                  <a href="#comment-form" class="reply" 
                     data-comment-id="{{ comment.id }}">
                    <i class="bi bi-reply-fill"></i> Répondre
                  </a>
                </h5>
                <time datetime="{{ comment.created_at|date:'Y-m-d' }}">
                  {{ comment.created_at|date:"d M Y" }}
                </time>
                <p>{{ comment.content }}</p>
              </div>
            </div>

            {% for reply in comment.replies.all %}
            <div id="comment-reply-{{ reply.id }}" class="comment comment-reply">
              <div class="d-flex">
                <div class="comment-img">
                  {% if reply.author and reply.author.profile.avatar %}
                  <img src="{{ reply.author.profile.avatar.url }}" alt="{{ reply.name }}" />
                  {% else %}
                  <img src="{% static 'assets/img/default-avatar.jpg' %}" alt="{{ reply.name }}" />
                  {% endif %}
                </div>
                <div>
                  <h5>
                    <a href="">{{ reply.name }}</a>
                  </h5>
                  <time datetime="{{ reply.created_at|date:'Y-m-d' }}">
                    {{ reply.created_at|date:"d M Y" }}
                  </time>
                  <p>{{ reply.content }}</p>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </section>

      <!-- Comment Form Section -->
      <section id="comment-form" class="comment-form section">
        <div class="container">
          <form method="post" action="">
            {% csrf_token %}
            <h4>Laisser un commentaire</h4>
            <p>Votre adresse e-mail ne sera pas publiée. Les champs obligatoires sont marqués *</p>

            {% if messages %}
            <div class="messages">
              {% for message in messages %}
              <div class="alert alert-{{ message.tags }}">
                {{ message }}
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <input type="hidden" name="parent_id" id="parent_id" value="">

            <div class="row">
              <div class="col-md-6 form-group">
                {{ comment_form.name }}
                {% if comment_form.name.errors %}
                <div class="invalid-feedback">
                  {{ comment_form.name.errors|join:", " }}
                </div>
                {% endif %}
              </div>
              <div class="col-md-6 form-group">
                {{ comment_form.email }}
                {% if comment_form.email.errors %}
                <div class="invalid-feedback">
                  {{ comment_form.email.errors|join:", " }}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <div class="col form-group">
                {{ comment_form.website }}
                {% if comment_form.website.errors %}
                <div class="invalid-feedback">
                  {{ comment_form.website.errors|join:", " }}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="row">
              <div class="col form-group">
                {{ comment_form.content }}
                {% if comment_form.content.errors %}
                <div class="invalid-feedback">
                  {{ comment_form.content.errors|join:", " }}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-primary">Publier le commentaire</button>
            </div>
          </form>
        </div>
      </section>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4 sidebar">
      <div class="widgets-container">
        <!-- Search Widget -->
        <div class="search-widget widget-item">
          <h3 class="widget-title">Rechercher</h3>
          <form action="{% url 'blog' %}" method="get">
            <input type="text" name="q" placeholder="Rechercher..." 
                   value="{{ request.GET.q|default:'' }}">
            <button type="submit" title="Search">
              <i class="bi bi-search"></i>
            </button>
          </form>
        </div>

        <!-- Categories Widget -->
        <div class="categories-widget widget-item">
          <h3 class="widget-title">Catégories</h3>
          <ul class="mt-3">
            {% for category in categories %}
            <li>
              <a href="{% url 'blog' %}?category={{ category.slug }}">
                {{ category.nom }} <span>({{ category.article_count }})</span>
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Recent Posts Widget -->
        <div class="recent-posts-widget widget-item">
          <h3 class="widget-title">Articles Récents</h3>
          {% for article in recent_articles %}
          <div class="post-item">
            {% if article.featured_image %}
            <img src="{{ article.featured_image.url }}" alt="{{ article.featured_image_alt }}" 
                 class="flex-shrink-0">
            {% endif %}
            <div>
              <h4>
                <a href="{% url 'blog_detail' article.slug %}">{{ article.titre }}</a>
              </h4>
              <time datetime="{{ article.published_at|date:'Y-m-d' }}">
                {{ article.published_at|date:"d M Y" }}
              </time>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Tags Widget -->
        <div class="tags-widget widget-item">
          <h3 class="widget-title">Tags</h3>
          <ul>
            {% for tag in tags %}
            <li>
              <a href="{% url 'blog' %}?tag={{ tag.slug }}">
                {{ tag.name }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Script pour gérer les réponses aux commentaires
document.querySelectorAll('.reply').forEach(button => {
    button.addEventListener('click', (e) => {
        e.preventDefault();
        const commentId = button.dataset.commentId;
        document.getElementById('parent_id').value = commentId;
        document.querySelector('#comment-form h4').textContent = 'Répondre au commentaire';
        document.querySelector('#comment-form').scrollIntoView({ behavior: 'smooth' });
    });
});
</script>
{% endblock %}